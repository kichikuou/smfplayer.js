/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {'use strict';function n(b){throw b;}var p=void 0,r=null,s=!1;function t(b){return function(a){this[b]=a}}var u,v=this;function x(b,a){var d=b.split("."),g=v;!(d[0]in g)&&g.execScript&&g.execScript("var "+d[0]);for(var c;d.length&&(c=d.shift());)!d.length&&a!==p?g[c]=a:g=g[c]?g[c]:g[c]={}}function y(b){var a=z;function d(){}d.prototype=a.prototype;b.Z=a.prototype;b.prototype=new d};function z(b,a,d){this.c=b;this.X=a;this.time=d}function A(b,a,d,g,c,e){z.call(this,b,a,d);this.H=g;this.w=c;this.z=e}y(A);function B(b,a,d,g){z.call(this,b,a,d);this.data=g}y(B);function C(b,a,d,g){z.call(this,b,a,d);this.data=g}y(C);function D(b,a){a=a||{};this.input=b;this.b=a.index||0}
D.prototype.parse=function(){var b=this.input,a=this.b,d=this.t={},g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"melo"!==g&&n(Error("invalid MFi signature:"+g));d.Y=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;d.U=(b[a++]<<16|b[a++])+a;d.V=b[a++];d.W=b[a++];d.k=b[a++];this.b=a;for(var b=this.input,a=this.b,d=this.j={},c;a<this.t.U;)switch(g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),c=b[a++]<<8|b[a++],g){case "titl":case "copy":case "vers":case "date":case "prot":d[g]=String.fromCharCode.apply(r,
b.subarray(a,a+=c));break;case "sorc":d[g]=b[a++];break;case "note":d[g]=b[a++]<<8|b[a++];break;default:d[g]=b.subarray(a,a+=c)}this.b=a;var b=this.input,a=this.b,e,h,f,d=this.i=[],j,g=0;for(c=this.t.k;g<c;++g){e=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"trac"!==e&&n(Error("invalid track signature:"+e));e=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];e=a+e;for(j=d[g]=[];a<e;){f={};f.deltaTime=b[a++];h=b[a++];if(255!==h)f.type="note",f.subType="Note",f.voice=h>>6,f.key=h&63,f.length=b[a++],1===this.j.note&&
(h=b[a++],f.velocity=h>>2,f.octaveShift=h&3);else switch(f.type="meta",h=b[a++],h>>4){case 11:switch(h&15){case 0:f.subType="MasterVolume";f.value=b[a++];break;case 10:f.subType="DrumScale";f.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:n(Error("unknown message type:"+h.toString(16)))}break;case 12:f.subType="SetTempo";f.value={timeBase:7===(h&7)?NaN:Math.pow(2,h&7)*(0===(h&8)?6:15),tempo:b[a++]};break;case 13:switch(h&15){case 0:f.subType="Point";f.value=b[a++];break;case 13:f.subType="Loop";
f.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:f.subType="Nop";f.value=b[a++];break;case 15:f.subType="EndOfTrack";f.value=b[a++];break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 14:switch(h&15){case 0:f.subType="InstrumentLowPart";f.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:f.subType="InstrumentHighPart";f.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:f.subType="Volume";f.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:f.subType=
"Valance";f.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:f.subType="PitchBend";f.value={part:b[a]>>6,value:b[a++]&63};break;case 5:f.subType="ChannelAssign";f.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:f.subType="VolumeChange";f.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:f.subType="PitchBendRange";f.value={part:b[a]>>6,value:b[a++]&63};break;case 9:f.subType="MasterCoarseTuning";f.value={part:b[a]>>6,value:b[a++]&63};break;case 10:f.subType="Modulation";f.value={part:b[a]>>
6,depth:b[a++]&63};break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 15:switch(h&15){case 0:f.subType="EditInstrument";h=f;var l=b[a++]<<8|b[a++],l=a+l,i=[],k=p;for(1!==b[a++]&&n(Error("invalid EditInstrument const value:"+b[a-1]));a<l;)k={},k.part=b[a++]>>4&3,k.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},k.carrier={ML:b[a]>>5,
VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},k.octaveSelect=b[a++]&3,i.push(k);h.value=i;break;case 1:f.subType="Vibrato";h=f;a++;a++;1!==b[a++]&&n(Error("invalid Vibrato const value:"+b[a-1]));l={part:b[a++]>>5&3,"switch":b[a++]>>6};h.value=l;break;case 15:f.subType="DeviceSpecific";h=f;l=b[a++]<<8|b[a++];l=a+l;17!==b[a++]&&n(Error("invalid DeviceSpecific const value:"+b[a-
1]));l={data:b.subarray(a,a+=l-a)};h.value=l;break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;default:n(Error("unkwnon message type:"+h.toString(16)))}j.push(f)}a=e}this.b=a};
function F(b){var a={timeDivision:48},d=a.tracks=[],a=a.plainTracks=[],g=b.i,c,e,h,f,j,l,i,k,m,w,q=[];for(i=0;16>i;++i)a[i]=[],q[i]=0;i=0;for(k=g.length;i<k;++i){c=g[i];f=[];j=l=m=0;for(w=c.length;m<w;++m)switch(e=c[m],j+=e.deltaTime,e.id=l,e.time=j,e.subType){case "Nop":break;case "Note":f[l++]=e;f[l]={id:l,type:"internal",subType:"NoteOff",time:j+e.length,key:e.key,voice:e.voice,velocity:e.velocity,octaveShift:e.octaveShift};l++;break;case "InstrumentHighPart":h=e;e=c[++m];"InstrumentLowPart"!==
e.subType&&n(Error("broken instrument"));f[l]={id:l,type:"internal",subType:"ProgramChange",time:j,part:e.value.part,instrument:h.value.instrument<<6|e.value.instrument};l++;break;default:f[l++]=e}f.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});d[i]=[];j=m=0;for(w=f.length;m<w;++m){e=f[m];j=e.time;switch(e.subType){case "Note":h=G(e.key+45,e.octaveShift);c=4*i+e.voice;9===c&&(h-=10);a[c].push(H(j-q[c]).concat(144|c,h,2*e.velocity));break;case "NoteOff":h=
G(e.key+45,e.octaveShift);c=4*i+e.voice;9===c&&(h-=10);a[c].push(H(j-q[c]).concat(128|c,h,2*e.velocity));break;case "ProgramChange":c=4*i+e.part;a[c].push(H(j-q[c]).concat(192|c,e.instrument));break;case "SetTempo":h=288E7/(e.value.tempo*e.value.timeBase);c=0;a[c].push(H(j-q[c]).concat(255,81,3,h>>16&255,h>>8&255,h&255));break;case "Loop":h=e.value.count;h="LOOP_"+(0===e.value.point?"START":"END")+"=ID:"+e.value.id+",COUNT:"+(0===h?-1:h);c=0;a[c].push(H(j-q[c]).concat([255,6,h.length],h.split("").map(function(a){return a.charCodeAt(0)})));
break;case "MasterVolume":h=e.value;c=0;a[c].push(H(j-q[c]).concat(240,7,127,127,4,1,h,h,247));break;case "Modulation":c=4*i+e.value.part;a[c].push(H(j-q[c]).concat(176|c,1,2*e.value.depth));break;case "Volume":c=4*i+e.value.part;a[c].push(H(j-q[c]).concat(176|c,7,2*e.value.volume));break;case "Valance":c=4*i+e.value.part;a[c].push(H(j-q[c]).concat(176|c,10,2*(e.value.valance-32)+64));break;case "PitchBend":c=4*i+e.value.part;a[c].push(H(j-q[c]).concat(224|c,2*e.value.value,2*e.value.value));break;
case "PitchBendRange":c=4*i+e.value.part;a[c].push(H(j-q[c]).concat(176|c,100,0),[0,176|c,101,0],[0,176|c,6,2*e.value.value]);break;case "MasterCoarseTuning":c=4*i+e.value.part;a[c].push(H(j-q[c]).concat(176|c,100,0),[0,176|c,101,2],[0,176|c,6,2*e.value.value]);break;default:continue}q[c]=e.time}}d=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];if(b.j.copy!==p){b=b.j.copy;e=b.length;f=Array(e);for(g=0;g<e;++g)f[g]=b.charCodeAt(g);g=f;b=g.length;g=[0,255,2].concat(H(b),g);a[0].unshift(g)}e=0;for(b=a.length;e<
b;++e){i=a[e];g=[];f=0;for(j=i.length;f<j;++f)Array.prototype.push.apply(g,i[f]);j=g.length;f=[77,84,114,107,j>>24&255,j>>16&255,j>>8&255,j&255];d=d.concat(f,g)}return new Uint8Array(d)}function G(b,a){var d=[0,12,-24,-12];if(d[a]!==p)return b+d[a];n(Error("invalid OctaveShift value:"+a))}function H(b){for(var a=[];128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a};function J(b,a){a=a||{};this.input=b;this.b=a.index||0;this.length=a.length||b.length-this.b;this.offset=this.b;this.padding=a.padding!==p?a.padding:!0;this.G=a.bigEndian!==p?a.bigEndian:s}
J.prototype.parse=function(){var b=this.length+this.offset;for(this.n=[];this.b<b;){var a=this.input,d=this.b,g=p;this.n.push({type:String.fromCharCode(a[d++],a[d++],a[d++],a[d++]),size:g=this.G?(a[d++]<<24|a[d++]<<16|a[d++]<<8|a[d++])>>>0:(a[d++]|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,offset:d});d+=g;this.padding&&1===(d-this.offset&1)&&d++;this.b=d}};function K(b,a){var d=b.n[a];return d===p?r:d};function L(b,a){a=a||{};a.padding=s;a.bigEndian=!0;this.input=b;this.b=a.index||0;this.m=0;this.l=new J(b,a);this.i=[];this.A=[]}L.prototype.parse=function(){var b,a;this.l.parse();b=K(this.l,this.m++);a=this.input;var d=b.offset;(!b||"MThd"!==b.type)&&n(Error("invalid header signature"));this.I=a[d++]<<8|a[d++];this.k=a[d++]<<8|a[d++];this.T=a[d++]<<8|a[d++];b=0;for(a=this.k;b<a;++b)M(this)};
function M(b){function a(){var a=0,b;do b=g[c++],a=a<<7|b&127;while(0!==(b&128));return a}var d=K(b.l,b.m++),g=b.input,c=d.offset,e,h,f,j=-1,l=-1,i,k=0,m,w;(!d||"MTrk"!==d.type)&&n(Error("invalid header signature"));for(var d=d.offset+d.size,q=[],I=[];c<d;){e=a();k+=e;m=c;w=g[c++];h=w>>4&15;f=w&15;8>h?(h=j,f=l,w=j<<4|l,c--,m--):(j=h,l=f);var E=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(h){case 8:case 9:case 10:case 11:case 13:case 14:i=
new A(E[h],e,k,f,g[c++],g[c++]);break;case 12:i=new A(E[h],e,k,f,g[c++]);break;case 15:switch(f){case 0:i=a();247!==g[c+i-1]&&n(Error("invalid SysEx event"));i=new B("SystemExclusive",e,k,g.subarray(c,(c+=i)-1));break;case 7:i=a();i=new B("SystemExclusive(F7)",e,k,g.subarray(c,c+=i));break;case 15:h=g[c++];i=a();switch(h){case 0:i=new C("SequenceNumber",e,k,[g[c++],g[c++]]);break;case 1:i=new C("TextEvent",e,k,[String.fromCharCode.apply(r,g.subarray(c,c+=i))]);break;case 2:i=new C("CopyrightNotice",
e,k,[String.fromCharCode.apply(r,g.subarray(c,c+=i))]);break;case 3:i=new C("SequenceTrackName",e,k,[String.fromCharCode.apply(r,g.subarray(c,c+=i))]);break;case 4:i=new C("InstrumentName",e,k,[String.fromCharCode.apply(r,g.subarray(c,c+=i))]);break;case 5:i=new C("Lyrics",e,k,[String.fromCharCode.apply(r,g.subarray(c,c+=i))]);break;case 6:i=new C("Marker",e,k,[String.fromCharCode.apply(r,g.subarray(c,c+=i))]);break;case 7:i=new C("CuePoint",e,k,[String.fromCharCode.apply(r,g.subarray(c,c+=i))]);
break;case 32:i=new C("MidiChannelPrefix",e,k,[g[c++]]);break;case 47:i=new C("EndOfTrack",e,k,[]);break;case 81:i=new C("SetTempo",e,k,[g[c++]<<16|g[c++]<<8|g[c++]]);break;case 84:i=new C("SmpteOffset",e,k,[g[c++],g[c++],g[c++],g[c++],g[c++]]);break;case 88:i=new C("TimeSignature",e,k,[g[c++],g[c++],g[c++],g[c++]]);break;case 89:i=new C("KeySignature",e,k,[g[c++],g[c++]]);break;case 127:i=new C("SequencerSpecific",e,k,[g.subarray(c,c+=i)]);break;default:i=new C("Unknown",e,k,[h,g.subarray(c,c+=i)])}break;
default:v.console.log("unknown message:",w.toString(16))}break;default:n(Error("invalid status"))}e=c-m;m=g.subarray(m,m+e);m[0]=w;i instanceof A&&("NoteOn"===i.c&&0===i.z)&&(i.c=E[8],m=new Uint8Array([128|i.H,i.w,i.z]));I.push(m);q.push(i)}b.i.push(q);b.A.push(I)};function N(){this.f=5E5;this.h=s;this.position=0;this.r=this.s=this.q=this.p=s;this.F=1;this.v=16383}u=N.prototype;u.N=t("p");u.O=t("q");u.Q=t("s");u.P=t("r");u.stop=function(){var b;this.pause=!0;this.e=Date.now();if(this.a)for(b=0;16>b;++b)this.a.postMessage("midi,b"+b.toString(16)+",78,0")};u.L=function(){return this.a};
function O(b){b.stop();b.f=5E5;b.position=0;b.pause=s;b.g=r;b.e=-1;b.B=r;b.C=r;b.o=r;clearTimeout(b.d);b.h?P(b):b.a.addEventListener("message",function(a){"link,ready"===a.data&&P(b)},s)}u.play=function(){var b=this;this.a||n(Error("WebMidiLink not found"));this.h?(this.g instanceof Array&&this.position>=this.g.length&&(this.position=0),Q(this)):this.a.addEventListener("message",function(a){"link,ready"===a.data&&(b.h=!0,Q(b))},s)};
function P(b){var a;for(a=0;16>a;++a)b.a.postMessage("midi,b"+a.toString(16)+",07,64"),b.a.postMessage("midi,b"+a.toString(16)+",0a,40"),b.a.postMessage("midi,e"+a.toString(16)+",00,40"),b.a.postMessage("midi,b"+a.toString(16)+",64,00"),b.a.postMessage("midi,b"+a.toString(16)+",65,00"),b.a.postMessage("midi,b"+a.toString(16)+",06,02"),b.a.postMessage("midi,b"+a.toString(16)+",26,00")}
u.S=function(b){var a=this;this.a=b;this.a.addEventListener("message",function(b){"link,ready"===b.data&&(a.h=!0,a.D(a.v))},s)};u.D=function(b){this.v=b;this.a&&this.a.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(b&127).toString(16)).substr(-2),("0"+(b>>7&127).toString(16)).substr(-2),"7f"].join())};u.R=t("F");
function Q(b){function a(){var b=c[h].time,l=c.length,i,k,m=Date.now();if(d.pause)d.e=Date.now()-d.e;else{do{i=c[h].event;"SetTempo"===i.c&&(d.f=i.data[0]);"ControlChange"===i.c&&111===i.w&&(f[0]={pos:h});if("Marker"===i.c&&("A"===i.data[0]&&(f[0]={pos:h}),"B"===i.data[0]&&d.q&&f[0]&&"number"===typeof f[0].pos)){h=f[0].pos;d.d=setTimeout(a,0);d.position=h;return}if("Marker"===i.c&&(i=i.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===i[1])f[i[2]|0]=f[i[2]]||{pos:h,count:i[3]|
0};else if("END"===i[1]&&d.s){k=f[i[2]|0];if(0!==k.count){0<k.count&&k.count--;h=k.pos;d.d=setTimeout(a,0);d.position=h;return}f[i[2]|0]=r}e.postMessage(c[h++].webMidiLink)}while(h<l&&c[h].time===b);h<l?(m=Date.now()-m,d.d=setTimeout(a,d.f/(1E3*g)*(c[h].time-b-m)*(1/d.F))):d.p&&f[0]&&"number"===typeof f[0].pos?(h=f[0].pos,d.d=setTimeout(a,0)):d.r&&(b=d,b.f=5E5,b.position=0,Q(d));d.position=h}}var d=b,g=b.B.T,c=b.g,e=b.a,h=b.position||0,f=[];b.pause?(b.d=setTimeout(a,b.e),b.pause=s,b.e=-1):b.d=setTimeout(a,
b.f/1E3*g*b.g[0].time)}
u.u=function(b){b=new L(b);O(this);b.parse();var a=this.g=[],d,g,c,e=this.o=[],h,f,j,l;g=b.i;d=Array(g.length);c=b.A;h=0;for(f=g.length;h<f;++h)d[h]=0;h=0;for(f=g.length;h<f;++h){d=g[h];j=0;for(l=d.length;j<l;++j)0===b.I&&"SequenceTrackName"===d[j].c&&(this.C=d[j].data[0]),"CopyrightNotice"===d[j].c&&e.push(d[j].data[0]),a.push({track:h,eventId:j,time:d[j].time,event:d[j],webMidiLink:"midi,"+Array.prototype.map.call(c[h][j],function(a){return a.toString(16)}).join(",")})}a.sort(function(a,b){return a.time>
b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.B=b};u.M=function(b){b=new D(b);O(this);b.parse();this.u(F(b))};u.K=function(){return this.C};u.J=function(){return this.o};x("SMF.Player",N);x("SMF.Player.prototype.play",N.prototype.play);x("SMF.Player.prototype.stop",N.prototype.stop);x("SMF.Player.prototype.loadMidiFile",N.prototype.u);x("SMF.Player.prototype.loadMldFile",N.prototype.M);x("SMF.Player.prototype.setLoop",N.prototype.P);x("SMF.Player.prototype.setCC111Loop",N.prototype.N);x("SMF.Player.prototype.setFalcomLoop",N.prototype.O);x("SMF.Player.prototype.setMFiLoop",N.prototype.Q);x("SMF.Player.prototype.setWebMidiLink",N.prototype.S);
x("SMF.Player.prototype.getWebMidiLink",N.prototype.L);x("SMF.Player.prototype.setTempoRate",N.prototype.R);x("SMF.Player.prototype.setMasterVolume",N.prototype.D);x("SMF.Player.prototype.getCopyright",N.prototype.J);x("SMF.Player.prototype.getSequenceName",N.prototype.K);}).call(this); //@ sourceMappingURL=smfplayer.min.js.map
